<ng-container *ngIf="revisionMode; else createReportButtons">
    <div class="flex justify-center mb-4 gap-4">
        <nb-form-field>
            <nb-icon nbPrefix icon="alert-circle-outline"></nb-icon>
            <nb-select placeholder="Select Showcase" size="large" (selectedChange)="onHouseSelect($event)">
                <nb-option *ngFor="let house of houses" [value]="house.value">{{house.label}}</nb-option>
            </nb-select>
        </nb-form-field>

        <button nbButton status="primary" size="large" (click)="onSaveImport()">
            <nb-icon icon="save-outline"></nb-icon>
            Save
        </button>
        
        <button nbButton status="danger" size="large" (click)="onCancelImport()">
            <nb-icon icon="close-outline"></nb-icon>
            Cancel
        </button>
    </div>
</ng-container>

<ng-template #createReportButtons>
    <div class="flex justify-between mb-4">
        <div class="flex gap-3">
            <nb-form-field>
                <nb-icon nbPrefix icon="person-outline" pack="eva"></nb-icon>
                <input type="text" nbInput fieldSize="large" placeholder="Search">
            </nb-form-field>

            <nb-form-field>
                <nb-icon nbPrefix icon="alert-circle-outline"></nb-icon>
                <nb-select placeholder="Select Showcase" size="large" (selectedChange)="onHouseSelect($event)">
                    <nb-option *ngFor="let house of houses" [value]="house.value">{{house.label}}</nb-option>
                </nb-select>
            </nb-form-field>
        </div>
        <div class="flex gap-3">
            <button nbButton status="primary" size="large" (click)="uploadFile()">
                <nb-icon icon="upload-outline"></nb-icon>
                Upload
            </button>
            <button nbButton status="primary" size="large" (click)="showAddReport()">
                <nb-icon icon="plus"></nb-icon>
                Add Line
            </button>       
        </div>
    </div>
</ng-template>

<nb-card>
    <nb-card-body>
        <form [formGroup]="reportForm" (ngSubmit)="onCreateReportSubmit()">
            <table class="divide-muted-200 dark:divide-muted-700 min-w-full table-fixed divide-y mb-5">
                <thead [class.bg-violet-200]="revisionMode">
                    <tr>
                        <th *ngFor="let header of tableHeaders"
                            class="text-muted-700 dark:text-muted-400 text-center font-sans font-bold text-sm uppercase border-muted-200 dark:border-muted-700 last:border-e-none dark:bg-muted-800 border-r p-3">
                            {{ header }}
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-muted-200 dark:divide-muted-700 dark:bg-muted-800 divide-y" [class.bg-violet-100]="revisionMode">
                    <ng-container *ngIf="isNewReportVisible">
                        <tr class="bg-violet-100">
                            <td class="text-sm text-muted-500 dark:text-white p-1">
                                <input
                                    formControlName="client"
                                    type="text"
                                    nbInput
                                    fieldSize="small">
                            </td>
                            <td class="text-sm text-muted-500 dark:text-white p-1">
                                <app-dropdown
                                    (onOptionChange)="updateNewReport($event, 'salesPerson')"
                                    [fieldSize]="'small'"
                                    [options]="salesPeople">
                                </app-dropdown>
                            </td>
                            <td class="text-sm text-muted-800 dark:text-white p-1 capitalize text-center">
                                <app-dropdown
                                    (onOptionChange)="updateNewReport($event, 'picture')"
                                    [class]="'w-20 text-center'"
                                    [fieldSize]="'small'"
                                    [options]="booleanDropOptions">
                                </app-dropdown>
                            </td>
                            <td class="text-sm text-muted-800 dark:text-white p-1 capitalize text-center">
                                <input
                                    formControlName="paid"
                                    type="number"
                                    class="text-right w-20"
                                    nbInput
                                    fieldSize="small">
                            </td>
                            <td class="text-sm text-muted-800 dark:text-white p-1 text-center">
                                <app-dropdown
                                    (onOptionChange)="updateNewReport($event, 'positive')"
                                    [class]="'w-20 text-center'"
                                    [fieldSize]="'small'"
                                    [options]="booleanDropOptions">
                                </app-dropdown>
                            </td>
                            <td class="text-sm text-muted-800 dark:text-white p-1 text-center">
                                <input
                                    formControlName="rating"
                                    type="number"
                                    class="text-right w-20"
                                    nbInput
                                    fieldSize="small">
                            </td>
                            <td class="text-sm text-muted-800 dark:text-white p-1 text-center">
                                <input
                                    nbInput
                                    formControlName="submitted"
                                    class="text-center w-36"
                                    fieldSize="small"
                                    [nbDatepicker]="datepicker"
                                    placeholder="Date"
                                    format="dd.MM.yyyy">
                                <nb-datepicker #datepicker></nb-datepicker>
                            </td>
                            <td class="text-sm text-muted-800 dark:text-white p-1 text-center">
                                <input
                                    formControlName="platform"
                                    type="text"
                                    class="text-right"
                                    nbInput
                                    class="text-center w-32"
                                    fieldSize="small">
                            </td>
                            <td>
                                <div class="flex gap-2 justify-center">
                                    <button nbButton size="small" status="primary">
                                        <nb-icon icon="save-outline"></nb-icon>
                                    </button>
                                    <button nbButton size="small" (click)="showAddReport(false)">
                                        <nb-icon icon="close-outline"></nb-icon>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </ng-container>
                    
                    <tr 
                        *ngFor="let report of reports; let i = index"
                        [class.bg-violet-100]="currentReportEdit === report.id">
                        <td class="whitespace-nowrap text-sm text-muted-500 dark:text-white p-1">
                            <ng-container *ngIf="currentReportEdit === report.id || !report.client; else inputClient">
                                <input
                                    type="text"
                                    class="w-44"
                                    [value]="report.client || ''"
                                    (blur)="updateReport($event, 'client', report.id, true)"
                                    (keydown.enter)="updateReport($event, 'client', report.id, true)"
                                    nbInput
                                    fieldSize="small">
                            </ng-container>
                            <ng-template #inputClient>
                                {{ report.client }}
                            </ng-template>
                        </td>
                        <td class="whitespace-nowrap text-sm text-muted-500 dark:text-white p-1">
                            <ng-container *ngIf="currentReportEdit === report.id || !report.salesPerson; else inputSalesPerson">
                                <app-dropdown
                                    (onOptionChange)="updateReport($event, 'salesPerson', report.id)"
                                    [value]="report.salesPerson | dropdownOption:['name','id']"
                                    [fieldSize]="'small'"
                                    [options]="salesPeople">
                                </app-dropdown>
                            </ng-container>
                            <ng-template #inputSalesPerson>
                                {{ report.salesPerson | userName }}
                            </ng-template>
                        </td>
                        <td class="whitespace-nowrap text-sm text-muted-800 dark:text-white p-1 uppercase text-center">
                            <ng-container *ngIf="currentReportEdit === report.id || !report.picture; else inputPicture">
                                <app-dropdown
                                    (onOptionChange)="updateReport($event, 'picture', report.id)"
                                    [value]="report.picture"
                                    [fieldSize]="'small'"
                                    [class]="'w-20 text-center'"
                                    [options]="booleanDropOptions">
                                </app-dropdown>
                            </ng-container>
                            <ng-template #inputPicture>
                                {{ report.picture | booeanToString }}
                            </ng-template>
                        </td>
                        <td class="whitespace-nowrap text-sm text-muted-800 dark:text-white p-1 uppercase text-center">
                            <ng-container *ngIf="currentReportEdit === report.id || !report.paid; else inputPaid">
                                <input
                                    type="number"
                                    class="text-right w-20"
                                    [value]="report.paid || ''"
                                    (blur)="updateReport($event, 'paid', report.id, true)"
                                    (keydown.enter)="updateReport($event, 'paid', report.id, true)"
                                    nbInput
                                    fieldSize="small">
                            </ng-container>
                            <ng-template #inputPaid>
                                {{ report.paid }}
                            </ng-template>
                        </td>
                        <td class="whitespace-nowrap text-sm text-muted-800 dark:text-white p-1 uppercase text-center">
                            <ng-container *ngIf="currentReportEdit === report.id || !report.positive; else inputPositive">
                                <app-dropdown
                                    (onOptionChange)="updateReport($event, 'positive', report.id)"
                                    [fieldSize]="'small'"
                                    [value]="report.positive"
                                    [class]="'w-20 text-center'"
                                    [options]="booleanDropOptions">
                                </app-dropdown>
                            </ng-container>
                            <ng-template #inputPositive>
                                {{ report.positive | booeanToString }}
                            </ng-template>
                        </td>
                        <td class="whitespace-nowrap text-sm text-muted-800 dark:text-white p-1 text-center">
                            <ng-container *ngIf="currentReportEdit === report.id || !report.rating; else inputRating">
                                <input
                                    type="number"
                                    [value]="report.rating || ''"
                                    (blur)="updateReport($event, 'rating', report.id, true)"
                                    (keydown.enter)="updateReport($event, 'rating', report.id, true)"
                                    class="text-right w-20"
                                    nbInput
                                    fieldSize="small">
                            </ng-container>
                            <ng-template #inputRating>
                                {{ report.rating }}
                            </ng-template>
                        </td>
                        <td class="whitespace-nowrap text-sm text-muted-800 dark:text-white p-1 text-center">
                            <ng-container *ngIf="currentReportEdit === report.id || !report.submitted; else inputSubmitted">
                                <input
                                    nbInput
                                    class="text-center w-36"
                                    fieldSize="small"
                                    [value]="report.submitted | date:'mediumDate'"
                                    [nbDatepicker]="datepicker"
                                    placeholder="Date"
                                    format="dd.MM.yyyy">
                                <nb-datepicker
                                    #datepicker
                                    (dateChange)="updateReport($event, 'submitted', report.id)">
                                </nb-datepicker>
                            </ng-container>
                            <ng-template #inputSubmitted>
                                {{ report.submitted | date:"mediumDate" }}
                            </ng-template>
                        </td>
                        <td class="whitespace-nowrap text-sm text-muted-800 dark:text-white p-1 text-center">
                            <ng-container *ngIf="currentReportEdit === report.id ||!report.platform; else inputPlatform">
                                <input
                                    type="string"
                                    [value]="report.platform || ''"
                                    (blur)="updateReport($event, 'platform', report.id, true)"
                                    (keydown.enter)="updateReport($event, 'platform', report.id, true)"
                                    class="text-center w-32"
                                    nbInput
                                    fieldSize="small">
                            </ng-container>
                            <ng-template #inputPlatform>
                                {{ report.platform }}
                            </ng-template>
                        </td>
                        <td class="p-1">
                            <div class="flex gap-2 justify-center">
                                <ng-container *ngIf="currentReportEdit === report.id; else inputActions">
                                    <button nbButton type="button" size="small" status="primary">
                                        <nb-icon icon="save-outline"></nb-icon>
                                    </button>
                                    <button nbButton type="button" size="small" (click)="editReport()">
                                        <nb-icon icon="close-outline"></nb-icon>
                                    </button>
                                </ng-container>
                                <ng-template #inputActions>
                                    <button
                                        nbButton
                                        type="button"
                                        size="small"
                                        status="primary"
                                        (click)="editReport(report.id)">
                                        <nb-icon icon="edit-outline"></nb-icon>
                                    </button>
                                    <button
                                        nbButton
                                        type="button"
                                        size="small"
                                        status="danger"
                                        (click)="deleteRegister(dialog, report.id)">
                                        <nb-icon icon="trash-outline"></nb-icon>
                                    </button>
                                </ng-template>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </form>
    </nb-card-body>
</nb-card>

<ng-template #dialog let-data let-ref="dialogRef">
    <nb-card>
        <nb-card-header>
            <h4>
                <nb-icon icon="alert-triangle-outline"></nb-icon>
                Delete Register
            </h4>
        </nb-card-header>
        <nb-card-body>
            {{ data }}
        </nb-card-body>
        <nb-card-footer>
            <div class="flex gap-3 justify-end">
                <button nbButton status="primary" (click)="ref.close(true)">Aceptar</button>
                <button nbButton status="danger" (click)="ref.close(false)">Cancel</button>
            </div>
        </nb-card-footer>
    </nb-card>
</ng-template>